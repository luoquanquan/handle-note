<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("http://note.niubishanshan.top").hostname,root:"/",scheme:"Gemini",version:"7.7.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"search.json",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="安装 docker执行命令, 一键安装 1curl -sSL https:&#x2F;&#x2F;get.daocloud.io&#x2F;docker | sh  安装 docker-compose 利用国内镜像安装 docker-compose 实测秒下   1curl -L &quot;https:&#x2F;&#x2F;get.daocloud.io&#x2F;docker&#x2F;compose&#x2F;releases&#x2F;download&#x2F;1.27.4&#x2F;docker-co"><meta property="og:type" content="article"><meta property="og:title" content="sentry 部署记录"><meta property="og:url" content="http://note.niubishanshan.top/%E5%B7%A5%E7%A8%8B%E5%8C%96/%E5%8D%9A%E5%AE%A2%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/sentry%20%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/index.html"><meta property="og:site_name" content="圈圈的随手笔记"><meta property="og:description" content="安装 docker执行命令, 一键安装 1curl -sSL https:&#x2F;&#x2F;get.daocloud.io&#x2F;docker | sh  安装 docker-compose 利用国内镜像安装 docker-compose 实测秒下   1curl -L &quot;https:&#x2F;&#x2F;get.daocloud.io&#x2F;docker&#x2F;compose&#x2F;releases&#x2F;download&#x2F;1.27.4&#x2F;docker-co"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="/note-images/2021-01-08-12-04-14.png"><meta property="og:image" content="/note-images/2021-01-08-11-38-58.png"><meta property="article:published_time" content="2020-11-13T05:50:31.000Z"><meta property="article:modified_time" content="2021-03-25T02:32:39.291Z"><meta property="article:author" content="圈圈的圈"><meta property="article:tag" content="docker"><meta property="article:tag" content="sentry"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="/note-images/2021-01-08-12-04-14.png"><link rel="canonical" href="http://note.niubishanshan.top/%E5%B7%A5%E7%A8%8B%E5%8C%96/%E5%8D%9A%E5%AE%A2%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/sentry%20%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>sentry 部署记录 | 圈圈的随手笔记</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="圈圈的随手笔记" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div> <a href="https://github.com/luoquanquan" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">圈圈的随手笔记</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">路漫漫其修远兮, 吾将上下而求索</p></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://note.niubishanshan.top/%E5%B7%A5%E7%A8%8B%E5%8C%96/%E5%8D%9A%E5%AE%A2%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/sentry%20%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpeg"><meta itemprop="name" content="圈圈的圈"><meta itemprop="description" content="技术学习, 读书笔记, 生活感悟~"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="圈圈的随手笔记"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> sentry 部署记录</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-11-13 13:50:31" itemprop="dateCreated datePublished" datetime="2020-11-13T13:50:31+08:00">2020-11-13</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2021-03-25 10:32:39" itemprop="dateModified" datetime="2021-03-25T10:32:39+08:00">2021-03-25</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%B7%A5%E7%A8%8B%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">工程化</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>3.4k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>3 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="安装-docker"><a href="#安装-docker" class="headerlink" title="安装 docker"></a>安装 docker</h2><p>执行命令, 一键安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL https://get.daocloud.io/docker | sh</span><br></pre></td></tr></table></figure><h2 id="安装-docker-compose"><a href="#安装-docker-compose" class="headerlink" title="安装 docker-compose"></a>安装 docker-compose</h2><ul><li><p>利用国内镜像安装 <code>docker-compose</code> 实测秒下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L <span class="string">"https://get.daocloud.io/docker/compose/releases/download/1.27.4/docker-compose-<span class="variable">$(uname -s)</span>-<span class="variable">$(uname -m)</span>"</span> -o /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure></li><li><p>设置可运行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure></li></ul><p>ps: 如果没有执行这个命令的话, 使用 <code>docker-compose</code> 命令会报 <code>Permission Denied</code></p><h2 id="配置阿里云加速器"><a href="#配置阿里云加速器" class="headerlink" title="配置阿里云加速器"></a>配置阿里云加速器</h2><p>访问<a href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors?spm=5176.12901015.0.i12901015.76b5525caiPyWb" target="_blank" rel="noopener">阿里云镜像网址</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /etc/docker</span><br><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-<span class="string">'EOF'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://r3tdolb4.mirror.aliyuncs.com"</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure><h2 id="安装-git"><a href="#安装-git" class="headerlink" title="安装 git"></a>安装 git</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install git -y</span><br></pre></td></tr></table></figure><h2 id="获取-sentry"><a href="#获取-sentry" class="headerlink" title="获取 sentry"></a>获取 sentry</h2><ul><li>访问<a href="https://github.com/luoquanquan/onpremise.git" target="_blank" rel="noopener">onpremise</a></li><li><code>git clone https://github.com/luoquanquan/onpremise.git</code></li><li><code>git checkout bjh-sentry</code> 切换到项目专用分支</li><li>执行 <code>./install.sh</code>, 安装 <code>sentry</code></li></ul><p>安装过程中会提示是否创建管理员的邮箱. 可以这会儿创建, 也可以安装完成以后再创建. 安装完成后, 使用命令 <code>docker-compose up</code> 就可以启动 sentry. 访问 {IP:9000} 可以访问到相关内容.</p><h2 id="安装-nginx"><a href="#安装-nginx" class="headerlink" title="安装 nginx"></a>安装 nginx</h2><ul><li>执行 <code>yum install nginx -y</code> 在宿主机安装 <code>nginx</code></li><li>修改 <code>nginx.conf</code>(默认路径 <code>/usr/nginx/nginx.conf</code>)</li><li>把 <code>sentry</code> 对应的域名指向本地 <code>9000</code> 端口号</li><li>well done</li></ul><p><code>nginx</code> 默认限制的可上传文件大小是 <code>1m</code>, 但是项目中稍微大一点的 <code>sourceMap</code> 文件就会超出限制报 <code>413</code> 请求包体过大的错误. 需要在 nginx 配置文件 <code>http</code> 配置中添加 <code>client_max_body_size 50m;</code> 就行了…</p><h2 id="sentry-后台管理页面限制内网访问"><a href="#sentry-后台管理页面限制内网访问" class="headerlink" title="sentry 后台管理页面限制内网访问"></a>sentry 后台管理页面限制内网访问</h2><p>正常情况下, 判断内网直接使用 <code>nginx</code> 内置变量 <code>$remote_addr</code> 即可, 我们这里由于使用的环境是集群的环境, 所以需要判断的是 <code>$proxy_add_x_forwarded_for</code>, 在 <code>nginx/nginx.conf</code> 文件中添加一下内容.</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$proxy_add_x_forwarded_for</span> !<span class="regexp">~* ^111\.206\.214\.28.*)</span> &#123;</span><br><span class="line">        <span class="attribute">add_header</span> Content-Type <span class="string">"text/plain; chartset=utf-8"</span>;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">"you don't have access to visit this app, please contact the Administrator ~"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    proxy_pass http://sentry;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sentry 运行一段时间后, 服务器磁盘炸了 💥</p><h2 id="日志迁移"><a href="#日志迁移" class="headerlink" title="日志迁移"></a>日志迁移</h2><p>因为之前的 <code>nginx</code> 和 <code>sentry</code> 日志都是写到系统盘上, 事件变多的时候上报变多最终导致了磁盘挤满, 所以想到了将日志信息迁移到数据盘上(相对容量大一些)</p><p>由于 <code>sentry</code> 是通过 <code>docker</code> 启动起来的, 所以需要持久化的东西肯定是通过 <code>volume</code> 到宿主机的. 那么把 <code>volume</code> 路径修改到数据盘就 OK?</p><p>修改 <code>docker</code> 默认路径可以用 <a href="https://zhuanlan.zhihu.com/p/95533274" target="_blank" rel="noopener">参考文档</a> 中的方法</p><p>也可以用以下步骤:</p><ul><li><p><code>systemctl stop docker</code></p></li><li><p><code>vim /usr/lib/systemd/system/docker.service</code></p></li><li><p>找到 <code>EXECStart</code> 并在后边添加 <code>ExecStart=/usr/bin/dockerd --graph /mnt/local/docker</code><br><img src="/note-images/2021-01-08-12-04-14.png" alt="2021-01-08-12-04-14"></p></li><li><p><code>systecmtl daemon-reload</code></p></li><li><p><code>systemctl start docker</code></p></li></ul><h2 id="日志清理"><a href="#日志清理" class="headerlink" title="日志清理"></a>日志清理</h2><h3 id="sentry-清理"><a href="#sentry-清理" class="headerlink" title="sentry 清理"></a>sentry 清理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登陆 sentry_worker_1 容器</span></span><br><span class="line">$ docker <span class="built_in">exec</span> -it sentry_worker_1 bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保留 0 天数据, cleanup的使用 delete 命令删除 postgresql 数据，但 postgrdsql 对于delete, update 等操作, 只是将对应行标志为 DEAD, 并没有真正释放磁盘空间</span></span><br><span class="line">$ sentry cleanup  --days 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登陆 sentry_postgres_1 容器</span></span><br><span class="line">$ docker <span class="built_in">exec</span> -it sentry_postgres_1 bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行清理</span></span><br><span class="line">$ vacuumdb -U postgres -d postgres -v -f --analyze</span><br></pre></td></tr></table></figure><h3 id="nginx-日志清理"><a href="#nginx-日志清理" class="headerlink" title="nginx 日志清理"></a>nginx 日志清理</h3><p>通过 <code>nginx -t</code> 找到当前 <code>nginx</code> 配置文件, 并找到日志落盘的位置</p><p>如果不想保留 <code>nginx</code> 日志文件可以按照下边的方法直接清除所有的日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">mv /mnt/<span class="built_in">log</span>/nginx/access.log /mnt/<span class="built_in">log</span>/nginx/access.log.bak</span><br><span class="line">mv /mnt/<span class="built_in">log</span>/nginx/error.log /mnt/<span class="built_in">log</span>/nginx/error.log.bak</span><br><span class="line">/sbin/nginx -s reopen</span><br><span class="line">rm -rf  /mnt/<span class="built_in">log</span>/nginx/access.log.bak</span><br><span class="line">rm -rf  /mnt/<span class="built_in">log</span>/nginx/error.log.bak</span><br></pre></td></tr></table></figure><p>如果想要保留日志文件可以使用下边的方法(需要配合定时任务)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 复制日志文件</span></span><br><span class="line">cp /mnt/<span class="built_in">log</span>/nginx/error.log /mnt/<span class="built_in">log</span>/nginx/error-$(date -d <span class="string">"yesterday"</span> +<span class="string">"%Y%m%d"</span>).<span class="built_in">log</span></span><br><span class="line">cp /mnt/<span class="built_in">log</span>/nginx/access.log /mnt/<span class="built_in">log</span>/nginx/access-$(date -d <span class="string">"yesterday"</span> +<span class="string">"%Y%m%d"</span>).<span class="built_in">log</span></span><br><span class="line"><span class="comment"># 清空日志文件</span></span><br><span class="line">cat /dev/null &gt; /mnt/<span class="built_in">log</span>/nginx/error.log</span><br><span class="line">cat /dev/null &gt; /mnt/<span class="built_in">log</span>/nginx/access.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 3 天前的日志文件</span></span><br><span class="line">find /usr/<span class="built_in">local</span>/nginx/logs -mtime 3 -<span class="built_in">type</span> f -name \*.<span class="built_in">log</span> | xargs rm -rf</span><br></pre></td></tr></table></figure><h2 id="定时清理日志"><a href="#定时清理日志" class="headerlink" title="定时清理日志"></a>定时清理日志</h2><h3 id="编写清理脚本"><a href="#编写清理脚本" class="headerlink" title="编写清理脚本"></a>编写清理脚本</h3><ul><li>创建 <code>clear-tools</code> 并进入该目录</li><li>创建 <code>sentry-clear.sh</code> 并写入以下内容<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">docker <span class="built_in">exec</span> -it cc67cb44a5de sentry cleanup --days 0 &amp;&amp; docker <span class="built_in">exec</span> -it 7f7b67da4eae vacuumdb -U postgres -d postgres -v -f --analyze</span><br></pre></td></tr></table></figure></li><li>创建 <code>nginx-log-clear.sh</code> 并写入以下内容<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">mv /mnt/<span class="built_in">log</span>/nginx/access.log /mnt/<span class="built_in">log</span>/nginx/access.log.bak</span><br><span class="line">mv /mnt/<span class="built_in">log</span>/nginx/error.log /mnt/<span class="built_in">log</span>/nginx/error.log.bak</span><br><span class="line">/sbin/nginx -s reopen</span><br><span class="line">rm -rf  /mnt/<span class="built_in">log</span>/nginx/access.log.bak</span><br><span class="line">rm -rf  /mnt/<span class="built_in">log</span>/nginx/error.log.bak</span><br></pre></td></tr></table></figure></li><li>执行 <code>chmod +x /mnt/clear-tools</code> 为脚本目录添加执行权限</li></ul><h3 id="添加定时任务"><a href="#添加定时任务" class="headerlink" title="添加定时任务"></a>添加定时任务</h3><p>执行 <code>crontab -e</code> 并写入以下内容, 之后保存退出</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0 0 * * * /mnt/clear-tools/nginx-log-clear.sh</span><br><span class="line">0 0 * * * /mnt/clear-tools/sentry-clear.sh</span><br></pre></td></tr></table></figure><p>添加完成后可以通过 <code>crontab -l</code> 查看调度计划</p><p><img src="/note-images/2021-01-08-11-38-58.png" alt="2021-01-08-11-38-58"></p><h3 id="重启-crond-服务"><a href="#重启-crond-服务" class="headerlink" title="重启 crond 服务"></a>重启 crond 服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/service crond restart</span><br></pre></td></tr></table></figure><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://www.cnblogs.com/jinanxiaolaohu/p/8301786.html" target="_blank" rel="noopener">Docker 修改默认存储路径的一个方法</a></li><li><a href="https://zhuanlan.zhihu.com/p/95533274" target="_blank" rel="noopener">修改 Docker 的默认存储路径</a></li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/docker/" rel="tag"># docker</a> <a href="/tags/sentry/" rel="tag"># sentry</a></div><div class="post-nav"><div class="post-nav-item"><a href="/%E5%89%8D%E7%AB%AF/tips/position-fixed-%E5%A4%B1%E6%95%88/" rel="prev" title="position fixed 失效"><i class="fa fa-chevron-left"></i> position fixed 失效</a></div><div class="post-nav-item"> <a href="/%E5%89%8D%E7%AB%AF/%E5%8D%9A%E5%AE%A2%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/basic-js/substr-vs-substring/" rel="next" title="字符串中的 substring 和 substr 方法">字符串中的 substring 和 substr 方法<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装-docker"><span class="nav-text">安装 docker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装-docker-compose"><span class="nav-text">安装 docker-compose</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置阿里云加速器"><span class="nav-text">配置阿里云加速器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装-git"><span class="nav-text">安装 git</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#获取-sentry"><span class="nav-text">获取 sentry</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装-nginx"><span class="nav-text">安装 nginx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sentry-后台管理页面限制内网访问"><span class="nav-text">sentry 后台管理页面限制内网访问</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日志迁移"><span class="nav-text">日志迁移</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日志清理"><span class="nav-text">日志清理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sentry-清理"><span class="nav-text">sentry 清理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nginx-日志清理"><span class="nav-text">nginx 日志清理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定时清理日志"><span class="nav-text">定时清理日志</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#编写清理脚本"><span class="nav-text">编写清理脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加定时任务"><span class="nav-text">添加定时任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重启-crond-服务"><span class="nav-text">重启 crond 服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文档"><span class="nav-text">参考文档</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="圈圈的圈" src="/images/avatar.jpeg"><p class="site-author-name" itemprop="name">圈圈的圈</p><div class="site-description" itemprop="description">技术学习, 读书笔记, 生活感悟~</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">54</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">10</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">38</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://juejin.im/user/5837c2bd61ff4b006ca8d1b2" title="掘金 → https:&#x2F;&#x2F;juejin.im&#x2F;user&#x2F;5837c2bd61ff4b006ca8d1b2" rel="noopener" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i> 掘金</a></span><span class="links-of-author-item"><a href="https://github.com/luoquanquan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;luoquanquan" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:luo_quanquan@163.com" title="E-Mail → mailto:luo_quanquan@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-fw fa-rss"></i> RSS</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备17034706号-1</a></div><div class="copyright"> &copy; <span itemprop="copyrightYear">2021</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">圈圈的圈</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span title="站点总字数">82k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span title="站点阅读时长">1:14</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/js/theme-next-canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script></body></html>