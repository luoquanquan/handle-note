<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-1.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-1.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-1.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("http://note.niubishanshan.top").hostname,root:"/",scheme:"Gemini",version:"7.7.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"search.json",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="React 以前不知道的那些小点点~  React 事件对象处理猜猜看以下代码执行的逻辑 1234567891011121314151617handleClick(e) &amp;#123;    &#x2F;&#x2F; 事件对象 e 是经过处理的一个实例    console.log(e)    &#x2F;&#x2F; 事件对象所属的类    console.log(e.__proto__.constructor)    &#x2F;&#x2F; e.ta"><meta property="og:type" content="article"><meta property="og:title" content="interview-6"><meta property="og:url" content="http://note.niubishanshan.top/%E5%89%8D%E7%AB%AF/interview/interview-6/index.html"><meta property="og:site_name" content="圈圈的随手笔记"><meta property="og:description" content="React 以前不知道的那些小点点~  React 事件对象处理猜猜看以下代码执行的逻辑 1234567891011121314151617handleClick(e) &amp;#123;    &#x2F;&#x2F; 事件对象 e 是经过处理的一个实例    console.log(e)    &#x2F;&#x2F; 事件对象所属的类    console.log(e.__proto__.constructor)    &#x2F;&#x2F; e.ta"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="/note-images/2020-03-14-18-00-56.png"><meta property="article:published_time" content="2020-03-14T08:50:31.000Z"><meta property="article:modified_time" content="2020-06-28T07:28:52.194Z"><meta property="article:author" content="圈圈的圈"><meta property="article:tag" content="interview"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="/note-images/2020-03-14-18-00-56.png"><link rel="canonical" href="http://note.niubishanshan.top/%E5%89%8D%E7%AB%AF/interview/interview-6/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>interview-6 | 圈圈的随手笔记</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="圈圈的随手笔记" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div> <a href="https://github.com/luoquanquan" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">圈圈的随手笔记</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">路漫漫其修远兮, 吾将上下而求索</p></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://note.niubishanshan.top/%E5%89%8D%E7%AB%AF/interview/interview-6/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpeg"><meta itemprop="name" content="圈圈的圈"><meta itemprop="description" content="技术学习, 读书笔记, 生活感悟~"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="圈圈的随手笔记"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> interview-6</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-03-14 16:50:31" itemprop="dateCreated datePublished" datetime="2020-03-14T16:50:31+08:00">2020-03-14</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-06-28 15:28:52" itemprop="dateModified" datetime="2020-06-28T15:28:52+08:00">2020-06-28</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>4.4k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>4 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>React 以前不知道的那些小点点~</p></blockquote><h2 id="React-事件对象处理"><a href="#React-事件对象处理" class="headerlink" title="React 事件对象处理"></a>React 事件对象处理</h2><p>猜猜看以下代码执行的逻辑</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">handleClick(e) &#123;</span><br><span class="line">    <span class="comment">// 事件对象 e 是经过处理的一个实例</span></span><br><span class="line">    <span class="built_in">console</span>.log(e)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事件对象所属的类</span></span><br><span class="line">    <span class="built_in">console</span>.log(e.__proto__.constructor)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// e.target 当前触发事件的元素</span></span><br><span class="line">    <span class="comment">// e.currentTarget 绑定事件的元素</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'e.target'</span>, e.target)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'e.currentTarget'</span>, e.currentTarget)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 原生事件对象</span></span><br><span class="line">    <span class="keyword">const</span> &#123;nativeEvent&#125; = e</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'nativeEvent.target'</span>, nativeEvent.target)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'nativeEvent.currentTarget'</span>, nativeEvent.currentTarget)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><a id="more"></a><p>执行的结果如下:<br><img src="/note-images/2020-03-14-18-00-56.png" alt="2020-03-14-18-00-56"></p><p>综上分析:</p><ul><li>事件对象是 <code>React</code> 基于原生的事件对象做的一层封装, 模拟了 DOM 事件的所有能力</li><li>可以通过 <code>e.nativeEvent</code> 获取到原生事件对象</li><li><code>React</code> 包装的事件对象 e 利用事件委托将所有的事件都绑定到了 <code>document</code> 上</li></ul><h3 id="React-中使用合成事件的原因"><a href="#React-中使用合成事件的原因" class="headerlink" title="React 中使用合成事件的原因"></a>React 中使用合成事件的原因</h3><ul><li>更好的兼容性和跨平台实现</li><li>所有事件挂载到 document 上, 减少了内存的消耗. 避免了频繁的绑定和解绑事件</li><li>方便事件的统一管理(如: transaction 事务机制)</li></ul><p>事件对比相关的代码在<a href="https://github.com/luoquanquan/learn-fe/commit/2d89119625f27afde906c2a2da49d19565f449a1" target="_blank" rel="noopener">这里</a></p><h2 id="事件处理函数的-this-指定问题"><a href="#事件处理函数的-this-指定问题" class="headerlink" title="事件处理函数的 this 指定问题"></a>事件处理函数的 this 指定问题</h2><p>修改事件处理函数如下:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">handleClick() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此后, 每次点击点击按钮打印的内容并没有按照预想的方式执行. 而是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">undefined</span><br></pre></td></tr></table></figure><p>出现这个的原因, 就要看下<a href="https://juejin.im/post/5c50168fe51d452d7b70e4cb" target="_blank" rel="noopener">这篇文章</a>了</p><p>那么下来我们来解决这个问题</p><ul><li>使用箭头函数(babel 需添加 <code>transform-class-properties</code> 插件)<a href="https://github.com/luoquanquan/learn-fe/commit/5d971e08b45d0c781dc552410e03f9e9e4ac752c" target="_blank" rel="noopener">参考代码</a></li><li>注册事件处理器时绑定函数<a href="https://github.com/luoquanquan/learn-fe/commit/c2009919dc6eaa0cd092956d1e3bd586586e9fc0" target="_blank" rel="noopener">参考代码</a></li><li>组件构造函数中绑定函数<a href="https://github.com/luoquanquan/learn-fe/commit/539eb19fd7f51225f1544961b8aa2765ad3cea02" target="_blank" rel="noopener">参考代码</a></li></ul><h2 id="setState-参数值的类型为不可变值"><a href="#setState-参数值的类型为不可变值" class="headerlink" title="setState 参数值的类型为不可变值"></a>setState 参数值的类型为不可变值</h2><h3 id="参数值类型为直接类型"><a href="#参数值类型为直接类型" class="headerlink" title="参数值类型为直接类型"></a>参数值类型为直接类型</h3><p>数字/字符串/布尔值/null/undefined 直接给需要修改的状态赋一个新的值即可…</p><p>ex:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.setState(&#123;</span><br><span class="line">    name: <span class="string">'quanquan'</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="参数值类型为引用类型"><a href="#参数值类型为引用类型" class="headerlink" title="参数值类型为引用类型"></a>参数值类型为引用类型</h3><h4 id="数组类型值"><a href="#数组类型值" class="headerlink" title="数组类型值"></a>数组类型值</h4><h4 id="新增元素"><a href="#新增元素" class="headerlink" title="新增元素"></a>新增元素</h4><ul><li>使用数组的 <code>concat</code> 方法</li><li>使用 es6 <code>...</code> 运算符解构原素组</li></ul><h4 id="截取部分元素"><a href="#截取部分元素" class="headerlink" title="截取部分元素"></a>截取部分元素</h4><p>使用 slice 方法</p><h4 id="过滤部分元素"><a href="#过滤部分元素" class="headerlink" title="过滤部分元素"></a>过滤部分元素</h4><p>使用 filter 方法</p><h4 id="PS"><a href="#PS" class="headerlink" title="PS"></a>PS</h4><p>不要使用会改写原数组的方法, 如: push/pop/shift/unshift/splice…</p><h4 id="对象类型值"><a href="#对象类型值" class="headerlink" title="对象类型值"></a>对象类型值</h4><ul><li>使用 Object.assign</li><li>使用 es6 <code>...</code> 运算符解构原对象</li></ul><h2 id="生命周期函数"><a href="#生命周期函数" class="headerlink" title="生命周期函数"></a>生命周期函数</h2><h3 id="组件挂载阶段"><a href="#组件挂载阶段" class="headerlink" title="组件挂载阶段"></a>组件挂载阶段</h3><ul><li><code>constructor</code> es6 特有的~</li><li><code>componentWillMount</code> 挂载 DOM 前调用, 此时调用 <code>setState</code> 不会触发组件的重新渲染</li><li><code>render</code> 构建 vNode, 必须是纯函数</li><li><code>componentDidMount</code> 组件完全挂载到 DOM 后触发, 一般用于发起 ajax…</li></ul><h3 id="组件更新阶段"><a href="#组件更新阶段" class="headerlink" title="组件更新阶段"></a>组件更新阶段</h3><blockquote><p>组件更新触发时机: 1. 父组件触发 render 2. 组件自身 setState</p></blockquote><ul><li><code>componentWillReceiveProps(nextProps)</code><ul><li>只有父组件 <code>render</code> 时触发, 组件内调用 <code>setState</code> 不会触发</li><li><code>nextProps</code> 的值可能和 <code>this.props</code> 的值是一样的</li><li>在这个方法中执行 <code>setState</code> 只有在 <code>render</code> 之后获取的 <code>this.state</code> 才是最新的 <code>state</code>, <code>render</code> 之前获取的 <code>this.state</code> 仍然为更新前的 <code>state</code></li></ul></li><li><code>shouldComponentUpdate(nextProps, nextState)</code> 决定了是否继续执行更新的过程, 如果该方法返回 <code>false</code> 后续的生命周期函数将不再触发</li><li><code>componentWillUpdate(nextProps, nextState)</code></li><li><code>render</code></li><li><code>componentDidUpdate(prevProps, prevState)</code> 两个参数对应的是组件更新前的 props 和 state</li></ul><h4 id="PS-1"><a href="#PS-1" class="headerlink" title="PS"></a>PS</h4><p>shouldComponentUpdate 和 componentWillUpdate 中都不能调用 setState, 否则会引起循环调用问题, render永远无法被调用, 组件也无法正常渲染</p><h3 id="卸载阶段"><a href="#卸载阶段" class="headerlink" title="卸载阶段"></a>卸载阶段</h3><p><code>componentWillUnmount</code> 主要进行组件的清理工作</p><p>eg:</p><ul><li>未完结定时器清除</li><li>未完成 ajax 取消</li></ul><p>组件生命周期函数<a href="https://github.com/luoquanquan/learn-fe/commit/97d6111b6a2886c55143181dd08e364f1b017bbb" target="_blank" rel="noopener">示例代码</a></p><h2 id="非受控组件"><a href="#非受控组件" class="headerlink" title="非受控组件"></a>非受控组件</h2><p>原则上优先使用受控组件, 但是有些情况下只能使用非受控组件</p><ul><li>手动操作 DOM</li><li>文件上传</li><li>video/audio/canvas 标签</li><li>富文本编辑器</li></ul><h2 id="Portals"><a href="#Portals" class="headerlink" title="Portals"></a>Portals</h2><blockquote><p>React 组件默认是按照组件的层级渲染的, 但是有些业务场景下需要将一些控件(例: 全局弹窗)需要挂载到父组件之外.</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">renderPop() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'renderPop'</span>)</span><br><span class="line">    <span class="keyword">return</span> ReactDOM.createPortal(<span class="xml"><span class="tag">&lt;<span class="name">Child</span> /&gt;</span></span>, <span class="built_in">document</span>.body)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 <code>Portals</code> 可以实现将 <code>React</code> 组件直接挂载到原生 <code>node</code> 节点上</p><h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ul><li>父组件定义了 <code>overflow: hidden;</code> 但是想要子组件脱离父组件</li><li>父组件 <code>z-index</code> 太小, 子元素无法展示</li><li><code>fixed</code> 元素需要在 <code>body</code> 的第一层</li></ul><p>ps: 定位方式为 <code>position: fixed;</code> 的元素, 直接作为 <code>body</code> 的一级子元素兼容性更好(UC 浏览器)</p><p>Portals <a href="https://github.com/luoquanquan/learn-fe/commit/cbcb122fe038451821487fc59fae8c141c797dde" target="_blank" rel="noopener">参考代码</a></p><h2 id="使用-context-实现数据跨层级传递"><a href="#使用-context-实现数据跨层级传递" class="headerlink" title="使用 context 实现数据跨层级传递"></a>使用 context 实现数据跨层级传递</h2><p><a href="https://github.com/luoquanquan/learn-fe/commit/b5fa3d06d345322d2a38176ad31272521d4620c2" target="_blank" rel="noopener">参考代码</a></p><h2 id="this-setState-同步-异步"><a href="#this-setState-同步-异步" class="headerlink" title="this.setState 同步 || 异步"></a>this.setState 同步 || 异步</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="keyword">super</span>()</span><br><span class="line">        <span class="keyword">this</span>.state = &#123; <span class="attr">count</span>: <span class="number">0</span> &#125;</span><br><span class="line">        <span class="keyword">this</span>.handleClick = <span class="keyword">this</span>.handleClick.bind(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    handleClick() &#123;</span><br><span class="line">        <span class="keyword">this</span>.setState(<span class="function">(<span class="params">&#123;count&#125;</span>) =&gt;</span> (&#123;<span class="attr">count</span>: count + <span class="number">1</span>&#125;))</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.state.count)</span><br><span class="line">        <span class="keyword">this</span>.setState(<span class="function">(<span class="params">&#123;count&#125;</span>) =&gt;</span> (&#123;<span class="attr">count</span>: count + <span class="number">1</span>&#125;))</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.state.count)</span><br><span class="line"></span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.setState(<span class="function">(<span class="params">&#123;count&#125;</span>) =&gt;</span> (&#123;<span class="attr">count</span>: count + <span class="number">1</span>&#125;))</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="keyword">this</span>.state.count)</span><br><span class="line">            <span class="keyword">this</span>.setState(<span class="function">(<span class="params">&#123;count&#125;</span>) =&gt;</span> (&#123;<span class="attr">count</span>: count + <span class="number">1</span>&#125;))</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="keyword">this</span>.state.count)</span><br><span class="line">        &#125;, <span class="number">1e3</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    componentDidMount() &#123;</span><br><span class="line">        <span class="keyword">this</span>.btn2.addEventListener(<span class="string">'click'</span>, <span class="keyword">this</span>.handleClick)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;count&#125; = <span class="keyword">this</span>.state</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div className=<span class="string">"app"</span>&gt;</span><br><span class="line">                &lt;button onClick=&#123;<span class="keyword">this</span>.handleClick&#125;&gt;click Me&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">                &lt;button ref=&#123;ref =&gt; &#123;this.btn2 = ref&#125;&#125;&gt;click Me2&lt;/</span>button&gt;</span><br><span class="line">                &#123;count&#125;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>如上代码, 刷新后直接点击第一个按钮控制台打印的结果为:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0</span><br><span class="line">0</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td></tr></table></figure><p>如果点击第二个按钮, 打印的结果为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td></tr></table></figure><p>综上可以得出</p><ul><li>当 <code>setState</code> 正常使用时(在 react hook 函数 or 事件处理函数中直接使用时) 其为异步</li><li>当 <code>setState</code> 在 <code>setTimeout</code> or <code>DOM</code> 事件中使用时为同步</li></ul><p>ps: 异步与否与其在哪个函数中执行没有关系, 只与触发该函数执行的入口相关(是否触发 batchUpdate 机制)</p><p>此问题<a href="https://github.com/luoquanquan/learn-fe/commit/e9b865b00b55c80e5abf83a134e9bd43f95d3df0" target="_blank" rel="noopener">参考代码</a></p><h2 id="执行-setState-时-值可能会被合并"><a href="#执行-setState-时-值可能会被合并" class="headerlink" title="执行 setState 时, 值可能会被合并"></a>执行 setState 时, 值可能会被合并</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">handleClick() &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;<span class="attr">count</span>: <span class="keyword">this</span>.state.count + <span class="number">1</span>&#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.state.count)</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;<span class="attr">count</span>: <span class="keyword">this</span>.state.count + <span class="number">1</span>&#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.state.count)</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;<span class="attr">count</span>: <span class="keyword">this</span>.state.count + <span class="number">1</span>&#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.state.count)</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;<span class="attr">count</span>: <span class="keyword">this</span>.state.count + <span class="number">1</span>&#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.state.count)</span><br><span class="line">    <span class="keyword">this</span>.setState(<span class="function">(<span class="params">&#123;count&#125;</span>) =&gt;</span> (&#123;<span class="attr">count</span>: count + <span class="number">1</span>&#125;))</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.state.count)</span><br><span class="line">    <span class="keyword">this</span>.setState(<span class="function">(<span class="params">&#123;count&#125;</span>) =&gt;</span> (&#123;<span class="attr">count</span>: count + <span class="number">1</span>&#125;))</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.state.count)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如上所示的代码, 在事件处理函数中共执行 6 次 <code>this.setState</code> 首先根据上文可知, 所有的 console.log 均为 0.<br>其次, 在 render 中拿到的实际 count 的值为 3, 得出上边四次 <code>this.setState({})</code> 写法的只有一次生效了. 原因是在同一次 batchUpdate 内对象字面量写法的 state 进行了合并(基于 <code>Object.assign</code>). 然而使用回调函数式写法的就不存在相关的问题. 所以涉及到类似逻辑时候要使用回调函数产出新的 state 的写法</p><p><a href="https://github.com/luoquanquan/learn-fe/commit/910ced4bcb7c37ac8f1019adee5791d5a1d5d3e6" target="_blank" rel="noopener">示例代码</a></p><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://reactjs.org/docs/portals.html" target="_blank" rel="noopener">Portals</a></li><li><a href="https://zhuanlan.zhihu.com/p/30690734" target="_blank" rel="noopener">React的batchUpdate一点见解</a></li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/interview/" rel="tag"># interview</a></div><div class="post-nav"><div class="post-nav-item"><a href="/Tips/tips/life-long-learning/" rel="prev" title="Life Long Learning"><i class="fa fa-chevron-left"></i> Life Long Learning</a></div><div class="post-nav-item"> <a href="/%E5%89%8D%E7%AB%AF/interview/interview-7/" rel="next" title="interview-7">interview-7<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#React-事件对象处理"><span class="nav-text">React 事件对象处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#React-中使用合成事件的原因"><span class="nav-text">React 中使用合成事件的原因</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事件处理函数的-this-指定问题"><span class="nav-text">事件处理函数的 this 指定问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#setState-参数值的类型为不可变值"><span class="nav-text">setState 参数值的类型为不可变值</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#参数值类型为直接类型"><span class="nav-text">参数值类型为直接类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参数值类型为引用类型"><span class="nav-text">参数值类型为引用类型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#数组类型值"><span class="nav-text">数组类型值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#新增元素"><span class="nav-text">新增元素</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#截取部分元素"><span class="nav-text">截取部分元素</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#过滤部分元素"><span class="nav-text">过滤部分元素</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PS"><span class="nav-text">PS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#对象类型值"><span class="nav-text">对象类型值</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#生命周期函数"><span class="nav-text">生命周期函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#组件挂载阶段"><span class="nav-text">组件挂载阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#组件更新阶段"><span class="nav-text">组件更新阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#PS-1"><span class="nav-text">PS</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#卸载阶段"><span class="nav-text">卸载阶段</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#非受控组件"><span class="nav-text">非受控组件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Portals"><span class="nav-text">Portals</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用场景"><span class="nav-text">使用场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用-context-实现数据跨层级传递"><span class="nav-text">使用 context 实现数据跨层级传递</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#this-setState-同步-异步"><span class="nav-text">this.setState 同步 || 异步</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#执行-setState-时-值可能会被合并"><span class="nav-text">执行 setState 时, 值可能会被合并</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文档"><span class="nav-text">参考文档</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="圈圈的圈" src="/images/avatar.jpeg"><p class="site-author-name" itemprop="name">圈圈的圈</p><div class="site-description" itemprop="description">技术学习, 读书笔记, 生活感悟~</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">54</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">10</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">35</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://juejin.im/user/5837c2bd61ff4b006ca8d1b2" title="掘金 → https:&#x2F;&#x2F;juejin.im&#x2F;user&#x2F;5837c2bd61ff4b006ca8d1b2" rel="noopener" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i> 掘金</a></span><span class="links-of-author-item"><a href="https://github.com/luoquanquan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;luoquanquan" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:luo_quanquan@163.com" title="E-Mail → mailto:luo_quanquan@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-fw fa-rss"></i> RSS</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备17034706号-1</a></div><div class="copyright"> &copy; <span itemprop="copyrightYear">2020</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">圈圈的圈</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span title="站点总字数">76k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span title="站点阅读时长">1:09</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/js/theme-next-canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script></body></html>